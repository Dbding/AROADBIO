import React, { useState, useEffect, useRef } from 'react';
import { Camera, Upload, ShieldCheck, TreePine, AlertTriangle, Info, ChevronRight, Activity, CheckCircle2, RefreshCw, Banknote, Map, Waves } from 'lucide-react';

const apiKey = ""; // 執行環境會自動提供

// 整合文件後的完整工法清單與金額概估
const CONSTRUCTION_METHODS = [
  { id: 1, name: "緩坡化V/U型邊溝＋粗糙化", type: "排水＋逃生", scenario: "新作/改建邊溝", benefit: "降低陷阱、提升可爬出率", risk: "斷面需滿足排洪；施工精度要求", maintenance: "清疏淤積、檢查粗糙面脫落", avoid: "流速極大且需光滑面以防壅塞者", estCost: "1,500 - 3,000 / m" },
  { id: 2, name: "局部逃生坡道（側向斜坡道）", type: "既有溝改善", scenario: "既有矩形/直立壁溝", benefit: "解除逃生陷阱", risk: "若設置不當恐集水淤積", maintenance: "定期清理坡道端淤泥", avoid: "溝內長期滿水、無逃生需求之封閉系統", estCost: "8,000 - 15,000 / 座" },
  { id: 3, name: "橫跨溝渠棧道", type: "連通跨越", scenario: "排水溝造成移動阻隔處", benefit: "降低阻隔、導引跨越", risk: "需抗滑與抗沖；不得妨礙排水", maintenance: "檢查固定與破損", avoid: "高沖刷、漂流木多且易卡堵處", estCost: "5,000 - 12,000 / 處" },
  { id: 4, name: "靜水池/集水井牆面緩坡化", type: "陷阱改善", scenario: "井/池具垂直壁面", benefit: "降低逃生障礙", risk: "需兼顧安全與水理功能", maintenance: "清淤與坡面完整性", avoid: "井池空間不足或結構無法改造", estCost: "15,000 - 35,000 / 處" },
  { id: 5, name: "靜水池內另設緩斜坡道", type: "陷阱改善", scenario: "無法緩坡化牆面時", benefit: "提供逃生路徑", risk: "需避免高吸熱材；坡道不得影響排洪", maintenance: "清理附著物、檢修表面", avoid: "池內長期高流速沖刷區", estCost: "12,000 - 25,000 / 處" },
  { id: 6, name: "涵洞/箱涵兼作通道", type: "通行＋排水", scenario: "橫向排水設施、既有涵洞", benefit: "提升穿越成功率", risk: "需兼顧消能與維護；阻塞風險", maintenance: "定期清疏、檢查底床", avoid: "漂流木/土砂量大且維護不可及處", estCost: "20,000 - 60,000 / 處" },
  { id: 7, name: "涵洞內棧道", type: "兼容常流水", scenario: "涵洞常有水流", benefit: "讓陸域動物可通行", risk: "斷面縮減需檢核水理", maintenance: "清理棧道淤積、檢修固定", avoid: "水位變動劇烈且棧道易被掏蝕", estCost: "3,000 - 6,000 / m" },
  { id: 8, name: "洞口/出水口消能＋緩斜坡道", type: "防沖＋通行銜接", scenario: "洞口落差/沖刷風險", benefit: "降低沖刷並利通行", risk: "設計需與水理穩定一致", maintenance: "補強位移塊石、清淤", avoid: "場地受限、無法確保穩定之急流區", estCost: "40,000 - 100,000 / 處" },
  { id: 9, name: "邊溝—野溪銜接緩斜坡道", type: "銜接與防下切", scenario: "邊溝排入坑溝/野溪", benefit: "提供安全出入＋避免下切", risk: "固床工需耐沖；設置位置需審慎", maintenance: "檢查淘刷、補強固床", avoid: "野溪動床劇烈、無法維持坡道口者", estCost: "50,000 - 120,000 / 處" },
  { id: 10, name: "導引/阻絕圍籬", type: "降路殺", scenario: "通道兩側、路殺熱點", benefit: "引導動物走通道、減少上路", risk: "圍籬破損即失效", maintenance: "定期巡檢修補", avoid: "未設通道卻設圍籬造成更大阻隔者", estCost: "1,200 - 2,500 / m" },
  { id: 11, name: "多孔性護岸 (石籠/砌石)", type: "護岸/擋土＋復育", scenario: "坡趾保護、護岸需透水處", benefit: "孔隙棲地＋植生界面", risk: "需檢核穩定與沖刷", maintenance: "補植補土、檢查變形", avoid: "高落差急流且需剛性護坦者", estCost: "3,500 - 5,500 / m3" },
  { id: 12, name: "植生工法 (打樁編柵/噴植)", type: "邊坡穩定＋復育", scenario: "相對穩定邊坡、表土可保留", benefit: "恢復微棲地、降侵蝕", risk: "初期養護需求高", maintenance: "補植、灑水、除外來種", avoid: "滑動明顯或需立即承載之邊坡", estCost: "500 - 1,500 / m2" },
  { id: 13, name: "路肩入滲/植草溝", type: "逕流分散", scenario: "路肩/平台可配置處", benefit: "降逕流集中、改善水文", risk: "土壤滲透性需確認；淤塞風險", maintenance: "清淤、維持植生", avoid: "高含泥砂且維護不足導致淤滿者", estCost: "800 - 2,000 / m" },
  { id: 14, name: "施工期臨時排水＋沉砂", type: "施工期保護", scenario: "開挖、臨時導改段", benefit: "降泥砂入水、保護水域", risk: "需與雨期風險匹配", maintenance: "暴雨後即刻清理", avoid: "未配置維護人力之長工期工程", estCost: "專案總額 2-5%" },
  // 延伸工法 (源自檔案內容)
  { id: 15, name: "河岸林緩衝帶 (複層植生帶)", type: "棲地營造", scenario: "路側緊鄰溪流或坑溝", benefit: "降水溫、提供有機碎屑、過濾污染", risk: "需耐沖刷物種；土地產權爭議", maintenance: "移除強勢外來種、補植原生樹種", avoid: "河道狹窄恐阻礙排洪處", estCost: "1,200 - 2,500 / m2" },
  { id: 16, name: "階梯式/踏步式側向斜坡道", type: "極致逃生", scenario: "高落差或垂直高護岸", benefit: "多階緩衝利於小型生物爬行", risk: "易淤積泥砂需頻繁清疏", maintenance: "階梯縫隙清淤、結構檢查", avoid: "洪水沖刷力極大之主河道", estCost: "15,000 - 45,000 / 座" },
  { id: 17, name: "複式斷面固床工/潛壩", type: "坡降控制", scenario: "路下溪床嚴重下切影響基礎", benefit: "穩定床面、營造魚類避難深潭", risk: "需檢核整體水理穩定度", maintenance: "災後檢查基礎淘刷", avoid: "地質極度破碎帶", estCost: "150,000 - 400,000 / 座" }
];

const SCHEMES = [
  { id: 'A', name: "「安全優先＋陷阱清零」基準方案", desc: "優先處理最具致命性的排水溝與集水井陷阱，消除路廊內的「生物死亡帶」。", methods: [1, 2, 4, 16] },
  { id: 'B', name: "「路域－水域一體化」連通方案", desc: "強化道路與周邊水脈、溪流的連動性，將排水轉化為生態廊道。", methods: [6, 8, 9, 15, 17] },
  { id: 'C', name: "「棲地韌性與緩衝」復育方案", desc: "著重於路側植生帶營造與多孔性結構，提升環境自癒力。", methods: [10, 11, 12, 13, 15] }
];

export default function App() {
  const [image, setImage] = useState(null);
  const [analyzing, setAnalyzing] = useState(false);
  const [analysisResult, setAnalysisResult] = useState(null);
  const [activeTab, setActiveTab] = useState('upload'); 
  const [error, setError] = useState(null);

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setImage(reader.result);
        setAnalysisResult(null);
      };
      reader.readAsDataURL(file);
    }
  };

  const analyzeImage = async () => {
    if (!image) return;
    setAnalyzing(true);
    setError(null);

    const base64Image = image.split(',')[1];
    
    const prompt = `你是一位農路與水土保持生態專家。請分析這張農路現地照片，並根據以下文件標準判斷：
    1. 排水系統：是否有垂直壁面？是否需要逃生坡道或階梯式設計？
    2. 生態連通：是否有涵洞落差？是否緊鄰溪流需要河岸林緩衝或複式固床？
    3. 邊坡穩定：是否裸露需植生或多孔性護岸？
    
    請以 JSON 格式回傳（注意工法編號可包含新加入的 15-17）：
    {
      "risks": ["具體風險描述1", "具體風險描述2"],
      "findings": "細節觀察，並提及對應文件(如生物通道叢書)的觀察點",
      "suggestedSchemeIds": ["A", "B"],
      "suggestedMethodIds": [1, 16, 15],
      "budgetRange": "概估總工程金額(萬)",
      "ecologicalPriority": "高/中/低 (根據風險評定)"
    }`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: prompt },
              { inlineData: { mimeType: "image/png", data: base64Image } }
            ]
          }],
          generationConfig: { responseMimeType: "application/json" }
        })
      });

      const data = await response.json();
      const result = JSON.parse(data.candidates[0].content.parts[0].text);
      setAnalysisResult(result);
      setActiveTab('result');
    } catch (err) {
      console.error(err);
      setError("分析失敗，這可能是因為圖片不清晰或連線問題。");
    } finally {
      setAnalyzing(false);
    }
  };

  return (
    <div className="min-h-screen bg-stone-50 text-stone-900 font-sans p-4 md:p-8">
      <div className="max-w-5xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden border border-stone-200">
        {/* Header */}
        <header className="bg-emerald-900 p-6 text-white relative">
          <div className="flex items-center gap-3">
            <div className="bg-emerald-100/20 p-2 rounded-lg">
              <TreePine className="w-8 h-8 text-emerald-300" />
            </div>
            <div>
              <h1 className="text-xl font-bold">農路生態友善工法決策系統 v2.0</h1>
              <p className="text-emerald-200 text-xs opacity-90">依據《水保生物通道叢書》及《生態工程手冊》建置</p>
            </div>
          </div>
        </header>

        {/* Navigation Tabs */}
        <nav className="flex border-b border-stone-100 bg-stone-50/50">
          {[
            { id: 'upload', label: '影像診斷', icon: Camera },
            { id: 'result', label: '決策與金額', icon: ShieldCheck },
            { id: 'methods', label: '工法數據庫', icon: Map }
          ].map(tab => (
            <button 
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              disabled={tab.id === 'result' && !analysisResult}
              className={`flex-1 flex items-center justify-center gap-2 py-4 text-sm font-bold transition-all ${activeTab === tab.id ? 'text-emerald-800 border-b-2 border-emerald-800 bg-white' : 'text-stone-400 opacity-80 disabled:opacity-30'}`}
            >
              <tab.icon className="w-4 h-4" />
              {tab.label}
            </button>
          ))}
        </nav>

        {/* Main Content */}
        <main className="p-6 md:p-8">
          
          {/* TAB: Upload */}
          {activeTab === 'upload' && (
            <div className="max-w-2xl mx-auto space-y-6">
              <div className="text-center mb-8">
                <h3 className="text-lg font-bold text-stone-700">上傳現地照片以識別生態缺口</h3>
                <p className="text-stone-400 text-sm">AI 將掃描排水、邊坡與水陸交流點的潛在風險</p>
              </div>

              <div className="relative group flex flex-col items-center justify-center border-2 border-dashed border-stone-300 rounded-3xl p-12 bg-stone-50 hover:bg-stone-100 hover:border-emerald-400 transition-all cursor-pointer">
                {image ? (
                  <div className="relative w-full">
                    <img src={image} alt="Preview" className="rounded-2xl shadow-2xl w-full h-80 object-cover" />
                    <button 
                      onClick={(e) => { e.stopPropagation(); setImage(null); setAnalysisResult(null); }}
                      className="absolute top-4 right-4 bg-white/90 text-stone-800 p-2 rounded-full shadow-lg hover:bg-red-50"
                    >
                      <RefreshCw className="w-5 h-5" />
                    </button>
                  </div>
                ) : (
                  <label className="flex flex-col items-center cursor-pointer w-full h-40 justify-center">
                    <Upload className="w-12 h-12 text-stone-300 mb-4 group-hover:text-emerald-500 transition-colors" />
                    <span className="text-stone-600 font-bold">點擊或拖放照片</span>
                    <input type="file" className="hidden" accept="image/*" onChange={handleFileUpload} />
                  </label>
                )}
              </div>

              {image && !analyzing && (
                <button 
                  onClick={analyzeImage}
                  className="w-full bg-emerald-700 hover:bg-emerald-800 text-white font-bold py-5 rounded-2xl shadow-xl transition-all transform hover:-translate-y-1 flex items-center justify-center gap-3"
                >
                  <Activity className="w-6 h-6" />
                  執行 AI 生態診斷與預算估算
                </button>
              )}

              {analyzing && (
                <div className="text-center py-12 bg-stone-50 rounded-3xl border border-stone-100">
                  <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-emerald-700 border-t-transparent mb-4"></div>
                  <p className="text-stone-600 font-bold">正在判讀工法與估算金額...</p>
                </div>
              )}

              {error && (
                <div className="bg-red-50 border border-red-100 text-red-700 p-4 rounded-2xl flex gap-3 animate-bounce">
                  <AlertTriangle className="w-5 h-5 flex-shrink-0" />
                  <p className="text-sm font-medium">{error}</p>
                </div>
              )}
            </div>
          )}

          {/* TAB: Analysis Results */}
          {activeTab === 'result' && analysisResult && (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-8 animate-in fade-in duration-500">
              
              {/* Left Column: Diagnostics */}
              <div className="md:col-span-2 space-y-8">
                <section>
                  <div className="flex items-center gap-2 mb-4">
                    <div className="p-1.5 bg-amber-100 rounded-md text-amber-700"><AlertTriangle className="w-5 h-5" /></div>
                    <h2 className="text-xl font-black text-stone-800">現地風險與觀察</h2>
                  </div>
                  <div className="bg-stone-50 rounded-2xl p-6 border border-stone-200">
                    <p className="text-stone-600 text-sm mb-6 leading-relaxed italic border-l-4 border-emerald-500 pl-4">
                      "{analysisResult.findings}"
                    </p>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      {analysisResult.risks.map((risk, i) => (
                        <div key={i} className="bg-white border border-stone-200 px-4 py-3 rounded-xl text-xs font-bold text-stone-700 flex items-start gap-2 shadow-sm">
                          <span className="text-amber-500 font-black mt-0.5">!</span> {risk}
                        </div>
                      ))}
                    </div>
                  </div>
                </section>

                <section>
                  <div className="flex items-center gap-2 mb-4">
                    <div className="p-1.5 bg-emerald-100 rounded-md text-emerald-700"><ShieldCheck className="w-5 h-5" /></div>
                    <h2 className="text-xl font-black text-stone-800">推薦應對方案</h2>
                  </div>
                  <div className="grid gap-4">
                    {SCHEMES.filter(s => analysisResult.suggestedSchemeIds.includes(s.id)).map(scheme => (
                      <div key={scheme.id} className="group border-2 border-emerald-50 rounded-2xl p-6 bg-white hover:border-emerald-200 transition-all shadow-sm">
                        <div className="flex items-center justify-between mb-3">
                          <h3 className="font-black text-emerald-900 text-lg">方案 {scheme.id}: {scheme.name}</h3>
                          <div className={`px-3 py-1 rounded-full text-[10px] font-black uppercase ${analysisResult.ecologicalPriority === '高' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`}>
                            優先級: {analysisResult.ecologicalPriority}
                          </div>
                        </div>
                        <p className="text-sm text-stone-500 mb-6 leading-relaxed">{scheme.desc}</p>
                        
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                          {CONSTRUCTION_METHODS.filter(m => scheme.methods.includes(m.id)).map(m => (
                            <div key={m.id} className="p-3 bg-stone-50 rounded-xl border border-stone-100 flex flex-col">
                              <span className="text-xs font-black text-stone-800 mb-1">{m.name}</span>
                              <div className="mt-auto flex items-center gap-1.5 text-emerald-600 font-mono text-[10px]">
                                <Banknote className="w-3 h-3" /> {m.estCost}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                </section>
              </div>

              {/* Right Column: Financial Summary */}
              <div className="space-y-6">
                <div className="bg-emerald-900 text-white rounded-3xl p-8 shadow-2xl sticky top-8">
                  <h3 className="text-emerald-300 font-black text-xs uppercase tracking-widest mb-4">預算估算總覽</h3>
                  <div className="mb-8">
                    <div className="text-4xl font-black mb-1">
                      <span className="text-lg mr-1">$</span>
                      {analysisResult.budgetRange}
                      <span className="text-lg ml-1">萬</span>
                    </div>
                    <p className="text-emerald-400 text-xs">專案初估金額 (含 10% 預備金)</p>
                  </div>
                  
                  <div className="space-y-4 border-t border-emerald-800 pt-6">
                    <div className="flex items-center gap-3">
                      <div className="bg-emerald-800 p-2 rounded-lg"><Waves className="w-4 h-4 text-emerald-300" /></div>
                      <div className="text-xs">
                        <p className="font-bold">河岸防護：中度投入</p>
                        <p className="text-emerald-400 opacity-80 italic">建議採多孔性工法</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <div className="bg-emerald-800 p-2 rounded-lg"><Info className="w-4 h-4 text-emerald-300" /></div>
                      <div className="text-xs">
                        <p className="font-bold">生態維護：預留 3%</p>
                        <p className="text-emerald-400 opacity-80 italic">含植生補植與清疏</p>
                      </div>
                    </div>
                  </div>

                  <button 
                    onClick={() => window.print()}
                    className="w-full mt-10 bg-white text-emerald-900 font-black py-4 rounded-2xl hover:bg-emerald-50 transition-colors flex items-center justify-center gap-2"
                  >
                    匯出專業評估報告
                  </button>
                </div>
              </div>

            </div>
          )}

          {/* TAB: Methods Gallery */}
          {activeTab === 'methods' && (
            <div className="space-y-6">
              <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <h2 className="text-2xl font-black text-stone-800">友善工法數據庫 (整合版)</h2>
                <div className="flex gap-2">
                  <span className="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-[10px] font-black uppercase">依文件分類</span>
                  <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-[10px] font-black uppercase">含預算概估</span>
                </div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {CONSTRUCTION_METHODS.map(method => (
                  <div key={method.id} className="group border border-stone-200 rounded-3xl bg-white hover:border-emerald-500 transition-all p-5 shadow-sm">
                    <div className="flex items-start justify-between mb-4">
                      <div className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-xl bg-stone-100 text-stone-700 flex items-center justify-center text-xs font-black">
                          {method.id}
                        </div>
                        <div>
                          <p className="font-black text-stone-900 text-base">{method.name}</p>
                          <p className="text-[10px] text-stone-400 font-bold uppercase tracking-wider">{method.type}</p>
                        </div>
                      </div>
                    </div>
                    
                    <div className="space-y-4">
                      <div className="flex items-center gap-2 text-emerald-700 font-mono font-bold text-sm bg-emerald-50 px-3 py-2 rounded-xl">
                        <Banknote className="w-4 h-4" />
                        <span className="text-[10px] opacity-70 mr-auto uppercase">概估金額 (TWD)</span>
                        {method.estCost}
                      </div>
                      
                      <div className="grid grid-cols-2 gap-4 text-[11px] leading-relaxed">
                        <div>
                          <p className="text-stone-400 font-black uppercase mb-1">生態效益</p>
                          <p className="text-stone-700 font-medium">{method.benefit}</p>
                        </div>
                        <div>
                          <p className="text-stone-400 font-black uppercase mb-1">維護要點</p>
                          <p className="text-stone-700 font-medium">{method.maintenance}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </main>

        {/* Dynamic Footer for Regulatory Context */}
        <footer className="bg-stone-50 p-8 border-t border-stone-100">
          <div className="max-w-4xl mx-auto flex flex-col md:flex-row gap-8">
            <div className="flex-1 space-y-3">
              <h4 className="font-black text-xs text-stone-500 uppercase tracking-widest">技術依據</h4>
              <ul className="text-[10px] text-stone-400 space-y-1.5 leading-relaxed">
                <li>• 行政院農業委員會《水土保持單元叢書 03：生物通道》 (2020)</li>
                <li>• 行政院公共工程委員會《生態工程手冊》 (2006 修訂)</li>
                <li>• 台灣山區農路生態友善工法 (Ecotechnology) 應用指南</li>
              </ul>
            </div>
            <div className="flex-1 space-y-3">
              <h4 className="font-black text-xs text-stone-500 uppercase tracking-widest">聲明</h4>
              <p className="text-[10px] text-stone-400 leading-relaxed italic">
                本系統金額僅供初步可行性評估參考，實際金額應依行政院公共工程委員會最新「公共工程資源價格資料庫」與現地水理條件調整。
              </p>
            </div>
          </div>
        </footer>
      </div>
    </div>
  );
}